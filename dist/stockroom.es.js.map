{"version":3,"file":"stockroom.es.js","sources":["../src/util.js","../src/index.js"],"sourcesContent":["export function assign(obj, props) {\n\tfor (let i in props) obj[i] = props[i];\n\treturn obj;\n}\n\n\nexport function applyUpdate(state, update) {\n\tif (Array.isArray(state)) {\n\t\tstate = state.slice(0, update.length);\n\t\tfor (let i=0; i<update.length; i++) {\n\t\t\tif (update[i]!==undefined) {\n\t\t\t\tstate[i] = applyOne(update[i], state[i]);\n\t\t\t}\n\t\t}\n\t}\n\telse {\n\t\tstate = assign({}, state);\n\t\tfor (let i in update) if (update.hasOwnProperty(i)) {\n\t\t\tif (update[i]===undefined) {\n\t\t\t\tdelete state[i];\n\t\t\t}\n\t\t\telse {\n\t\t\t\tstate[i] = applyOne(update[i], state[i]);\n\t\t\t}\n\t\t}\n\t}\n\treturn state;\n}\n\nfunction applyOne(obj, prev) {\n\tif (prev!=null && obj!=null && typeof prev==='object' && typeof obj==='object') {\n\t\treturn applyUpdate(prev, obj);\n\t}\n\treturn obj;\n}\n\n\nexport function diff(obj, prev) {\n\tlet update, i;\n\tif (Array.isArray(obj)) {\n\t\tupdate = new Array(obj.length);\n\t\tfor (i=0; i<obj.length; i++) {\n\t\t\tif (obj[i]!==prev[i]) {\n\t\t\t\tupdate[i] = diffOne(obj[i], prev[i]);\n\t\t\t}\n\t\t}\n\t}\n\telse {\n\t\tupdate = {};\n\t\tfor (i in obj) {\n\t\t\tif (obj.hasOwnProperty(i) && obj[i]!==prev[i]) {\n\t\t\t\tupdate[i] = diffOne(obj[i], prev[i]);\n\t\t\t}\n\t\t}\n\t}\n\treturn update;\n}\n\nfunction diffOne(obj, prev) {\n\tif (obj!=null && prev!=null && typeof obj==='object' && typeof prev==='object') {\n\t\treturn diff(obj, prev);\n\t}\n\treturn obj;\n}\n\n","import { assign, diff, applyUpdate } from './util';\n\n/** The main stockroom module, which runs on the main thread.\n *\t@name module:stockroom\n */\nlet stockroom; // eslint-disable-line\n\n\n/** Given a Web Worker instance, sets up RPC-based synchronization with a WorkerStore running within it.\n *\t@memberof module:stockroom\n *  @param {Worker} worker\t\tAn instantiated Web Worker (eg: `new Worker('./store.worker.js')`)\n *  @returns {Store} synchronizedStore - a mock unistore store instance sitting in front of the worker store.\n *\t@example\n *\timport createStore from 'stockroom'\n *\timport StoreWorker from 'worker-loader!./store.worker'\n *\tlet store = createStore(new StoreWorker)\n */\nexport default function createStore(worker) {\n\tlet listeners = [],\n\t\tstate = {},\n\t\tsendQueue = [],\n\t\tinitialized = false;\n\n\tfunction handleMessage({ data }) {\n\t\tif (typeof data!=='object') {}\n\t\telse if ('pop' in data) {\n\t\t\tif (data.length===1) {\n\t\t\t\tprocess(data[0]);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tfor (let i=0; i<data.length; i++) process(data[i]);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tprocess(data);\n\t\t}\n\t}\n\n\tfunction process(data) {\n\t\tlet { type, overwrite, update, action, initial, partial } = data;\n\t\tif (type==='@@STATE') {\n\t\t\tif (partial===true) {\n\t\t\t\tupdate = applyUpdate(state, update);\n\t\t\t\toverwrite = true;\n\t\t\t}\n\n\t\t\tsetState(update, overwrite===true, action, false, data.params);\n\n\t\t\tif (initial) {\n\t\t\t\tinitialized = true;\n\t\t\t\tprocessSendQueue();\n\t\t\t}\n\t\t}\n\t}\n\n\n\tworker.addEventListener('message', handleMessage);\n\n\tfunction setState(update, overwrite, action, replicate, params) {\n\t\tlet oldState = state;\n\t\tstate = assign(overwrite ? {} : assign({}, state), update);\n\t\tif (replicate) {\n\t\t\tlet update = overwrite ? state : diff(state, oldState);\n\t\t\tsend({ type: '@@STATE', overwrite, update, action, partial: !overwrite });\n\t\t\t// send({ type: '@@STATE', overwrite, update, action });\n\t\t}\n\t\tlet currentListeners = listeners;\n\t\tfor (let i=0; i<currentListeners.length; i++) currentListeners[i](state, action, update, params);\n\t}\n\n\tfunction send(opts) {\n\t\tif (sendQueue.push(opts)===1) {\n\t\t\tsetTimeout(processSendQueue);\n\t\t}\n\t}\n\n\tfunction processSendQueue() {\n\t\tif (initialized && sendQueue.length>0) {\n\t\t\tworker.postMessage(sendQueue);\n\t\t\tsendQueue.length = 0;\n\t\t}\n\t}\n\n\tfunction unsubscribe(listener) {\n\t\tlet out = [];\n\t\tfor (let i=0; i<listeners.length; i++) {\n\t\t\tif (listeners[i]===listener) {\n\t\t\t\tlistener = null;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tout.push(listeners[i]);\n\t\t\t}\n\t\t}\n\t\tlisteners = out;\n\t}\n\n\treturn {\n\t\taction(actionCreator) {\n\t\t\treturn (...params) => {\n\t\t\t\tlet action = typeof actionCreator==='function' ? actionCreator(...params) : actionCreator;\n\t\t\t\tif (typeof action==='string') action = { type: action, params: params.filter(notEvent) };\n\t\t\t\tif (action && !action.type) {\n\t\t\t\t\t// console.warn('Action running on main thread: ', actionCreator.name);\n\t\t\t\t\tsetState(action, false, actionCreator.name, true, params);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// console.log('ACTION', action.type, ...(action.params || [action.payload]));\n\t\t\t\t\tsend({ type: '@@ACTION', action });\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\t\tsetState(update, overwrite, action) {\n\t\t\treturn setState(update, overwrite, action, true);\n\t\t},\n\t\tgetState() {\n\t\t\treturn state;\n\t\t},\n\t\tsubscribe(listener) {\n\t\t\tlisteners.push(listener);\n\t\t\treturn () => { unsubscribe(listener); };\n\t\t},\n\t\tunsubscribe\n\t};\n}\n\n// Filter out DOM Events\nconst notEvent = e => !(e instanceof Event);\n"],"names":["assign","obj","props","let","i","applyUpdate","state","update","Array","isArray","slice","length","undefined","applyOne","hasOwnProperty","prev","diff","diffOne","const","notEvent","e","Event","worker","listeners","sendQueue","initialized","process","data","overwrite","action","initial","setState","params","processSendQueue","replicate","oldState","send","type","partial","currentListeners","opts","push","setTimeout","postMessage","unsubscribe","listener","out","addEventListener","ref","actionCreator","filter","name","getState","subscribe"],"mappings":"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"}